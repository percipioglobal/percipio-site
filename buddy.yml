- pipeline: "Build & Deploy to staging"
  trigger_mode: "MANUAL"
  ref_name: "staging"
  ref_type: "BRANCH"
  target_site_url: "https://sandbox.percipio.london/"
  trigger_condition: "ALWAYS"
  actions:
  - action: "Execute: webpack build"
    type: "BUILD"
    working_directory: "/buddy/percipio-site"
    docker_image_name: "nystudio107/webpack-dev-base"
    docker_image_tag: "latest"
    execute_commands:
    - "cd docker-config/webpack-dev-craft"
    - "npm ci"
    - "npm run build"
    setup_commands:
    - "npm install -g webpack webpack-cli"
    volume_mappings:
    - "/:/buddy/percipio-site"
    trigger_condition: "ALWAYS"
    shell: "BASH"
  - action: "Execute: composer install"
    type: "BUILD"
    working_directory: "/buddy/percipio-site"
    docker_image_name: "nystudio107/php-dev-base"
    docker_image_tag: "latest"
    execute_commands:
    - "cd cms"
    - "composer install --no-scripts --no-interaction --prefer-dist --optimize-autoloader --ignore-platform-reqs"
    setup_commands:
    - "echo \"memory_limit=-1\" >> /usr/local/etc/php/conf.d/buddy.ini"
    - "apt-get update && apt-get install -y git zip"
    - "curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer"
    - "# php ext pdo_pgsql"
    - "docker-php-ext-install pdo_pgsql pgsql"
    volume_mappings:
    - "/:/buddy/percipio-site"
    trigger_condition: "ALWAYS"
    shell: "BASH"
  - action: "Rsync to staging"
    type: "RSYNC"
    local_path: "cms/"
    remote_path: "$REMOTE_PROJECT_ROOT/deploy-cache"
    login: "$REMOTE_SSH_USER"
    host: "$REMOTE_SSH_HOST"
    port: "22"
    authentication_mode: "WORKSPACE_KEY"
    archive: true
    delete_extra_files: true
    recursive: true
    compress: true
    deployment_excludes:
    - "/.git/"
    trigger_condition: "ALWAYS"
  - action: "Atomic Deploy"
    type: "SSH_COMMAND"
    working_directory: "$REMOTE_PROJECT_ROOT"
    login: "$REMOTE_SSH_USER"
    host: "$REMOTE_SSH_HOST"
    port: "22"
    authentication_mode: "WORKSPACE_KEY"
    commands:
    - "if [ -d \"releases/$BUDDY_EXECUTION_REVISION\" ] && [ \"$BUDDY_EXECUTION_REFRESH\" = \"true\" ];"
    - "then"
    - " echo \"Removing: releases/$BUDDY_EXECUTION_REVISION\""
    - " rm -rf releases/$BUDDY_EXECUTION_REVISION;"
    - "fi"
    - "if [ ! -d \"releases/$BUDDY_EXECUTION_REVISION\" ];"
    - "then"
    - " echo \"Creating: releases/$BUDDY_EXECUTION_REVISION\""
    - " cp -dR deploy-cache releases/$BUDDY_EXECUTION_REVISION;"
    - "fi"
    - "echo \"Creating: persistent directories\""
    - "mkdir -p storage"
    - "mkdir -p transcoder"
    - "echo \"Symlinking: persistent files & directories\""
    - "ln -nfs $REMOTE_PROJECT_ROOT/.env $REMOTE_PROJECT_ROOT/releases/$BUDDY_EXECUTION_REVISION"
    - "ln -nfs $REMOTE_PROJECT_ROOT/storage $REMOTE_PROJECT_ROOT/releases/$BUDDY_EXECUTION_REVISION"
    - "ln -nfs $REMOTE_PROJECT_ROOT/transcoder $REMOTE_PROJECT_ROOT/releases/$BUDDY_EXECUTION_REVISION/web"
    - "echo \"Linking current to revision: $BUDDY_EXECUTION_REVISION\""
    - "rm -f current"
    - "ln -s releases/$BUDDY_EXECUTION_REVISION current"
    - "echo \"Removing old releases\""
    - "cd releases && ls -t | tail -n +11 | xargs rm -rf"
    trigger_condition: "ALWAYS"
    run_as_script: true
    shell: "BASH"
  - action: "Prep Craft CMS"
    type: "SSH_COMMAND"
    working_directory: "$REMOTE_PROJECT_ROOT/current"
    login: "$REMOTE_SSH_USER"
    host: "$REMOTE_SSH_HOST"
    port: "22"
    authentication_mode: "WORKSPACE_KEY"
    commands:
    - "# Ensure the craft script is executable"
    - "chmod a+x craft"
    - "# Restart our long running queue listener process"
    - "# echo \"\" | sudo -S supervisorctl restart all"
    - "# Backup the database just in case any migrations or Project Config changes have issues"
    - "#./craft backup/db"
    - "# Run pending migrations, sync project config, and clear caches"
    - "./craft migrate/all"
    - "./craft project-config/sync"
    - "./craft clear-caches/all"
    trigger_condition: "ALWAYS"
    run_as_script: true
    shell: "BASH"
  - action: "Send notification to dev-releases channel"
    type: "SLACK"
    content: "[#$BUDDY_EXECUTION_ID] $BUDDY_PIPELINE_NAME execution by $BUDDY_EXECUTION_REVISION_COMMITTER_NAME ."
    blocks: "[{\"type\":\"section\",\"fields\":[{\"type\":\"mrkdwn\",\"text\":\"*Successful execution:* <$BUDDY_EXECUTION_URL|Execution #$BUDDY_EXECUTION_ID $BUDDY_EXECUTION_COMMENT>\"},{\"type\":\"mrkdwn\",\"text\":\"*Pipeline:* <$BUDDY_PIPELINE_URL|$BUDDY_PIPELINE_NAME>\"},{\"type\":\"mrkdwn\",\"text\":\"*Branch:* $BUDDY_EXECUTION_BRANCH\"},{\"type\":\"mrkdwn\",\"text\":\"*Project:* <$BUDDY_PROJECT_URL|$BUDDY_PROJECT_NAME>\"}]}]"
    channel: "C015P48A8KT"
    channel_name: "dev-releases"
    trigger_condition: "ALWAYS"
    integration_hash: "5df89776aab2cb21934805aa"
  variables:
  - key: "PROJECT_URL"
    value: "https://sandbox.percipio.london/"
  - key: "REMOTE_PROJECT_ROOT"
    value: "/home/forge/sandbox.percipio.london"
  - key: "REMOTE_SSH_HOST"
    value: "167.99.199.1"